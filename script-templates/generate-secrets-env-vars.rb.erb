<%# This script is generated from an ERB template so that it's possible to know %>
<%# at run time which deps directory to use%>
#!/usr/bin/env ruby

require 'yaml'
require 'json'

$vault = "<%= $deps_dir %>/vault"

def authenticate_with_vault()
    `#{$vault} login -method=cf role=apps`
end

def read_secrets_config()
    app_secrets_file_path = File.expand_path(File.join(ENV["HOME"], "app-secrets.yml"))
    return YAML.safe_load(IO.read(app_secrets_file_path))
end

def read_app_details()
    vcap_application = JSON.parse(ENV["VCAP_APPLICATION"])
    return {
        "app_guid" => vcap_application["application_id"],
        "app_name" => vcap_application["application_name"],
        "space_guid" => vcap_application["space_id"],
        "org_guid" => vcap_application["organization_id"]
    }
end

def write_secrets_to_profile_d(secrets_config, app_details)
    # Secrets config is a set of key value pairs in the format
    # ENV_VAR_NAME = path/to/secret:key_within_secret
    #
    # The values can contain certain placeholder strings which are
    # subtituted at runtime
    # $APP_GUID_PATH = path to the app level secrets using the guid, without a trailing slash
    # $APP_NAME_PATH = path to the app level secrets using the name, without a trailing slash
    # $SPACE_PATH = path to space level secrets using the space guid, without a trailing slash
    # $ORG_PATH = path to the org level secrets using the org guid, without a trailing slash

    secrets_pairs = {}

    secrets_config.each do |env_var_name, path_and_key|
        original_path, key = split_configured_path(path_and_key)
        path_without_placeholders = replace_path_placeholders(original_path, app_details)
        secret_value = read_secret_value(path_without_placeholders, key)

        secrets_pairs[env_var_name] = secret_value
    end

    profile_d_content = secrets_pairs
        .map{ |key, value| "export #{key}=#{value}" }
        .join("\n")

    puts profile_d_content
end

def replace_path_placeholders(path, app_details)
    org_guid_path = "/cloudfoundry/orgs/#{app_details["org_guid"]}"
    space_guid_path = org_guid_path+"/spaces/#{app_details["space_guid"]}"

    placeholders = {
        "$APP_GUID_PATH" => space_guid_path+"/apps/#{app_details["app_guid"]}",
        "$APP_NAME_PATH" => space_guid_path+"/apps/#{app_details["app_name"]}",
        "$SPACE_PATH" => space_guid_path,
        "$ORG_PATH" => org_guid_path
    }

    subbed_path = path
    placeholders.each do |placeholder, value|
        subbed_path = subbed_path.sub(placeholder, value)
    end

    return subbed_path
end

def split_configured_path(path_and_key)
    parts = path_and_key.split(":")
    return [parts[0], parts[1]]
end

def read_secret_value(path, key)
    `#{$vault} kv get -field="#{key}" "#{path}"`
end

authenticate_with_vault()
secrets_config = read_secrets_config()
app_details = read_app_details()
write_secrets_to_profile_d(secrets_config, app_details)
